# Frigate Configuration (Config-First Pattern)

**Charter v7.0 Section 19**: Complex Service Configuration Pattern

---

## Overview

This directory contains the **canonical Frigate configuration** in `config.yml`. This file is:
- ✅ Version-controlled (tracked in git)
- ✅ Human-readable (standard YAML)
- ✅ Debuggable (edit directly, restart service)
- ✅ Portable (works with Docker/Podman/k8s)

**NOT** generated by Nix - Nix only handles container infrastructure (image, GPU, ports, volumes).

---

## Files

- **`config.yml`**: The canonical Frigate configuration (to be created from extraction)
- **`config.template.yml`**: Template with secret placeholders (if using templating strategy)
- **`config.baseline.yml`**: Snapshot of working config from old module (for reference)

---

## Editing Workflow

### To Change Frigate Behavior

1. **Edit `config.yml` directly**:
   ```bash
   $EDITOR domains/server/frigate/config/config.yml
   ```

2. **Validate config** (if Frigate provides validation):
   ```bash
   # Method 1: Use Frigate's built-in validator (if available)
   podman run --rm -v $(pwd)/config:/config \
     ghcr.io/blakeblackshear/frigate:0.16.2 \
     frigate config validate

   # Method 2: Use our verification script
   ./domains/server/frigate/scripts/verify-config.sh
   ```

3. **Test changes**:
   ```bash
   # Restart Frigate to apply changes
   sudo systemctl restart podman-frigate.service

   # Watch logs for errors
   podman logs -f frigate
   ```

4. **Commit when stable**:
   ```bash
   git add domains/server/frigate/config/config.yml
   git commit -m "feat(server.frigate): adjust camera detection zones"
   ```

---

## Secret Handling

**DO NOT** put secrets directly in `config.yml`!

### Option A: Secret File References

```yaml
# config.yml
cameras:
  cam1:
    ffmpeg:
      inputs:
        - path: rtsp://admin:PASSWORD_FROM_SECRET@192.168.1.101:554/ch01/0
```

Secrets are injected at runtime via environment variables or mounted files.

### Option B: Template with Placeholders

```yaml
# config.template.yml
cameras:
  cam1:
    ffmpeg:
      inputs:
        - path: rtsp://${RTSP_USER}:${RTSP_PASS_ENCODED}@${CAM1_IP}:554/ch01/0
```

Nix substitutes values before mounting to container.

**Current Strategy**: Secrets are handled via direct values in config.yml (stored in this repository)

---

## YAML Structure Reference

Frigate 0.16.x config structure:

```yaml
mqtt:
  enabled: true/false
  host: 127.0.0.1
  port: 1883

detectors:
  <detector_name>:
    type: onnx | tensorrt | cpu
    device: 0  # GPU number
    num_threads: 3

model:  # Top-level, NOT nested under detectors!
  model_type: yolo-generic | yolonas | yolox
  width: 640
  height: 640
  input_tensor: nchw
  input_pixel_format: rgb | bgr
  input_dtype: float  # CRITICAL for ONNX
  path: /config/models/model.onnx
  labelmap_path: /labelmap/coco-80.txt

cameras:
  <camera_name>:
    enabled: true
    ffmpeg:
      hwaccel_args: preset-vaapi  # or custom args
      inputs:
        - path: rtsp://...
          roles: [detect, record]
    detect:
      width: 1280
      height: 720
      fps: 5

go2rtc:
  streams:
    <camera_name>: ["rtsp://..."]
```

---

## Validation Checklist

Before committing config changes:

- [ ] YAML syntax is valid (`yamllint config.yml`)
- [ ] `model` block is **top-level**, not nested under `detectors`
- [ ] `input_dtype: float` is present for ONNX detector
- [ ] Camera RTSP paths are correct (or use placeholders for secrets)
- [ ] Detector type matches available GPU/hardware
- [ ] Tested with `./scripts/verify-config.sh`
- [ ] Frigate starts without errors
- [ ] All cameras come online
- [ ] Object detection is working

---

## Troubleshooting

### Config Changes Not Applying

```bash
# 1. Verify the file in the container matches your local file
podman exec frigate cat /config/config.yml

# 2. If it doesn't match, rebuild NixOS
sudo nixos-rebuild switch --flake .#hwc-server

# 3. Restart container
sudo systemctl restart podman-frigate.service
```

### YAML Syntax Errors

```bash
# Use yamllint for validation
yamllint domains/server/frigate/config/config.yml

# Or use yq for structure inspection
yq eval '.' config.yml
```

### Comparing Old vs New Config

```bash
# Extract old config
sudo podman exec frigate cat /config/config.yaml > /tmp/old-config.yml

# Compare
diff -u /tmp/old-config.yml domains/server/frigate/config/config.yml
```

---

## References

- **Frigate Documentation**: https://docs.frigate.video/configuration/
- **Charter v7.0 Section 19**: Config-First Pattern
- **Validation Script**: ../scripts/verify-config.sh
- **Module README**: ../README.md

---

**Last Updated**: 2025-11-24
**Config Pattern**: Config-first (Charter v7.0 §19)
