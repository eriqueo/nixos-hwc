{
  "name": "Frigate Surveillance Intelligence",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "frigate-events",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "frigate-events"
    },
    {
      "parameters": {
        "jsCode": "// Parse and filter Frigate events with smart priority\nconst event = $input.item.json.after || $input.item.json;\nconst now = new Date();\nconst hour = now.getHours();\n\n// Time-based context\nconst isNight = hour >= 22 || hour <= 6;\n\n// Event details\nconst eventId = event.id;\nconst camera = event.camera;\nconst object = event.label;\nconst score = event.top_score || 0;\n\n// Filter low confidence\nif (score < 0.6) {\n  return []; // Drop low confidence detections\n}\n\n// Determine priority\nlet priority = 2; // Info by default\nlet topic = 'hwc-monitoring';\nlet sendToSlack = false;\n\n// Critical: Person or car at night\nif ((object === 'person' && isNight) || (object === 'car' && isNight && camera === 'cobra_cam_3')) {\n  priority = 5;\n  topic = 'hwc-critical';\n  sendToSlack = true;\n}\n// High: Person during day\nelse if (object === 'person' && !isNight) {\n  priority = 4;\n  topic = 'hwc-alerts';\n}\n// Info: Animals, packages, etc.\nelse if (['dog', 'cat', 'package', 'bicycle'].includes(object)) {\n  priority = 2;\n  topic = 'hwc-monitoring';\n}\n// Drop known false positives\nelse if (['plant', 'tree'].includes(object)) {\n  return [];\n}\n\nreturn {\n  json: {\n    eventId: eventId,\n    camera: camera,\n    object: object,\n    score: score,\n    priority: priority,\n    topic: topic,\n    sendToSlack: sendToSlack,\n    isNight: isNight,\n    timestamp: now.toISOString()\n  }\n};"
      },
      "id": "parse-filter",
      "name": "Parse & Filter Events",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://127.0.0.1:5000/api/events/={{ $json.eventId }}/snapshot.jpg",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "fetch-snapshot",
      "name": "Fetch Event Snapshot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Generate context-aware notification\nconst { camera, object, score, priority, isNight } = $json;\n\n// Camera friendly names\nconst cameraNames = {\n  'cobra_cam_1': 'Front Door',\n  'cobra_cam_2': 'Driveway',\n  'cobra_cam_3': 'Backyard'\n};\n\nconst cameraName = cameraNames[camera] || camera;\n\n// Object emojis\nconst emojis = {\n  person: 'ðŸš¶',\n  car: 'ðŸš—',\n  dog: 'ðŸ•',\n  cat: 'ðŸˆ',\n  package: 'ðŸ“¦',\n  bicycle: 'ðŸš²'\n};\n\nconst emoji = emojis[object] || 'ðŸ‘ï¸';\n\n// Build title based on priority\nlet title;\nif (priority === 5) {\n  title = `ðŸ”´ CRITICAL: ${object} detected at ${cameraName}`;\n} else if (priority === 4) {\n  title = `âš ï¸ ${object} detected at ${cameraName}`;\n} else {\n  title = `${emoji} ${object} at ${cameraName}`;\n}\n\n// Build message\nconst confidencePercent = (score * 100).toFixed(0);\nconst timeContext = isNight ? 'ðŸŒ™ Night detection' : 'â˜€ï¸ Day detection';\nconst message = `${timeContext}\\n\\nConfidence: ${confidencePercent}%\\nTime: ${new Date().toLocaleString()}\\n\\nCamera: ${cameraName}`;\n\nreturn {\n  json: {\n    title: title,\n    message: message,\n    topic: $json.topic,\n    priority: priority,\n    tags: `frigate,${camera},${object},detection`,\n    sendToSlack: $json.sendToSlack\n  }\n};"
      },
      "id": "generate-notification",
      "name": "Generate Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.sendToSlack }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-slack",
      "name": "Check if Slack needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwc.ocelot-wahoo.ts.net/notify/={{ $json.topic }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Title",
              "value": "={{ $json.title }}"
            },
            {
              "name": "Tags",
              "value": "={{ $json.tags }}"
            },
            {
              "name": "Priority",
              "value": "={{ $json.priority }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-ntfy",
      "name": "Send to ntfy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \"{{ $json.title }}\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"{{ $json.message }}\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "send-slack",
      "name": "Send to Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "jsCode": "// Generate error notification\nconst error = $input.item.json.error || 'Unknown error';\nconst workflow = 'Frigate Surveillance Intelligence';\n\nreturn {\n  json: {\n    title: 'âš ï¸ Frigate Workflow Error',\n    message: `Workflow: ${workflow}\\n\\nError: ${error}\\n\\nCheck n8n and Frigate logs.`,\n    topic: 'hwc-alerts',\n    priority: 4,\n    tags: 'error,frigate,n8n'\n  }\n};"
      },
      "id": "error-notification",
      "name": "Error Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwc.ocelot-wahoo.ts.net/notify/={{ $json.topic }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Title",
              "value": "={{ $json.title }}"
            },
            {
              "name": "Tags",
              "value": "={{ $json.tags }}"
            },
            {
              "name": "Priority",
              "value": "={{ $json.priority }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-error-ntfy",
      "name": "Send Error to ntfy",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 500]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{ "node": "Parse & Filter Events", "type": "main", "index": 0 }]]
    },
    "Parse & Filter Events": {
      "main": [[{ "node": "Fetch Event Snapshot", "type": "main", "index": 0 }]]
    },
    "Fetch Event Snapshot": {
      "main": [[{ "node": "Generate Notification", "type": "main", "index": 0 }]]
    },
    "Generate Notification": {
      "main": [[{ "node": "Check if Slack needed", "type": "main", "index": 0 }]]
    },
    "Check if Slack needed": {
      "main": [
        [{ "node": "Send to ntfy", "type": "main", "index": 0 }, { "node": "Send to Slack", "type": "main", "index": 0 }],
        [{ "node": "Send to ntfy", "type": "main", "index": 0 }]
      ]
    },
    "Error Notification": {
      "main": [[{ "node": "Send Error to ntfy", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "surveillance",
      "id": "surveillance-tag"
    },
    {
      "name": "frigate",
      "id": "frigate-tag"
    },
    {
      "name": "automation",
      "id": "automation-tag"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-12-08T00:00:00.000Z",
  "versionId": "1"
}
