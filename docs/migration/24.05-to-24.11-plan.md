# NixOS 24.05 → 24.11 Migration Plan

**Date:** 2026-02-09
**Current Version:** 24.05.20241230 (Uakari)
**Target Version:** 24.11 (Vicuña)
**Machine:** hwc-server

---

## Executive Summary

Upgrading from 24.05 to 24.11 is relatively safe. Most breaking changes don't affect your server setup. The main benefit: **24.11 likely has better pgvecto-rs support**, which may fix your Immich database issue.

---

## Breaking Changes Analysis

### 1. NVIDIA Drivers - **REQUIRES ACTION**

**Change:** `hardware.nvidia.open` must be explicitly set (no default in 560+)

**Your Status:** ✅ Already handled
```nix
# machines/server/config.nix
hardware.nvidia.open = lib.mkForce false;  # Pascal doesn't support open-source modules
```

**Action:** None required

---

### 2. PostgreSQL - **REQUIRES ATTENTION**

**Changes:**
- PostgreSQL 12 removed (you use 15) ✅
- Default bumped to 16 (you explicitly set 15) ✅
- `shared_preload_libraries` argument escaping changed
- New hardening defaults applied

**Your Status:** Using PostgreSQL 15, explicitly pinned

**Action:**
- Verify PostgreSQL starts correctly after upgrade
- The `shared_preload_libraries = "vectors"` setting should still work
- May need to test extension loading

---

### 3. PipeWire Default - **NO ACTION (Server)**

**Change:** PipeWire is now default sound server instead of PulseAudio

**Your Status:** Server doesn't use desktop audio. Laptop explicitly enables PipeWire.

**Action:** None for server

---

### 4. qBittorrent - **NO IMPACT**

**Change:** `qbittorrent-qt5` removed, Qt 5 support dropped

**Your Status:** Using containerized qBittorrent (`lscr.io/linuxserver/qbittorrent:latest`)

**Action:** None - container handles its own Qt dependencies

---

### 5. Cgroup v1 Deprecated - **VERIFY**

**Change:** systemd 256 refuses to boot with cgroup v1

**Your Status:** Likely already on cgroup v2 (NixOS default since ~23.05)

**Action:** Verify with `cat /sys/fs/cgroup/cgroup.controllers` - if it shows controllers, you're on v2

---

### 6. dhcpcd Hardening - **LIKELY NO IMPACT**

**Change:** dhcpcd now runs as unprivileged user

**Your Status:** Server likely uses static IP or Tailscale

**Action:** Verify networking works after upgrade

---

### 7. Rust switch-to-configuration - **MONITOR**

**Change:** New Rust-based activation replaces Perl

**Your Status:** Automatic

**Action:** If activation fails, add `system.switch.enableNg = false` as fallback

---

### 8. Home Manager - **UPDATE INPUT**

**Change:** Need matching Home Manager version

**Your Status:** Currently using `release-24.05`

**Action:** Update to `release-24.11` in flake.nix

---

## Immich/pgvecto-rs Status

**Current Problem:**
- Database has `vchord` extension indexes
- `vchord` not available in 24.05's nixpkgs
- Extension file missing → database operations fail

**Expected in 24.11:**
- Newer pgvecto-rs version
- May include vchord support OR compatible replacement
- If vchord still unavailable, database will need cleanup

---

## Migration Steps

### Pre-Migration (Do First)

```bash
# 1. Backup current system
sudo cp -a /etc/nixos /etc/nixos.backup.24.05

# 2. Backup PostgreSQL databases
sudo -u postgres pg_dumpall > /mnt/hot/backups/postgresql-pre-24.11.sql

# 3. Check cgroup version
cat /sys/fs/cgroup/cgroup.controllers
# Should show: cpuset cpu io memory hugetlb pids rdma misc

# 4. Record current service status
systemctl list-units --failed > /tmp/failed-services-pre-upgrade.txt
```

### Flake Changes

```nix
# In flake.nix, change:

# OLD
nixpkgs-stable.url  = "github:NixOS/nixpkgs/nixos-24.05";
home-manager-stable = {
  url = "github:nix-community/home-manager/release-24.05";
  inputs.nixpkgs.follows = "nixpkgs-stable";
};
agenix-stable = {
  url = "github:ryantm/agenix/0.15.0";
  inputs.nixpkgs.follows = "nixpkgs-stable";
};

# NEW
nixpkgs-stable.url  = "github:NixOS/nixpkgs/nixos-24.11";
home-manager-stable = {
  url = "github:nix-community/home-manager/release-24.11";
  inputs.nixpkgs.follows = "nixpkgs-stable";
};
agenix-stable = {
  url = "github:ryantm/agenix";  # Use latest (compatible with 24.11)
  inputs.nixpkgs.follows = "nixpkgs-stable";
};
```

Also update stateVersion comment (but NOT the value):
```nix
# In flake.nix
home-manager.users.eric.home.stateVersion = "24.05";  # Keep as-is, don't change
```

### Update & Build

```bash
# 1. Update flake lock
cd ~/.nixos
nix flake update nixpkgs-stable home-manager-stable agenix-stable

# 2. Check for evaluation errors
nix flake check 2>&1 | tee /tmp/flake-check-24.11.log

# 3. Build without switching (test)
sudo nixos-rebuild build --flake .#hwc-server

# 4. If build succeeds, test activation
sudo nixos-rebuild test --flake .#hwc-server

# 5. If test succeeds, switch
sudo nixos-rebuild switch --flake .#hwc-server
```

### Post-Migration Verification

```bash
# 1. Check NixOS version
nixos-version
# Should show: 24.11.xxxxx

# 2. Check failed services
systemctl list-units --failed

# 3. Verify PostgreSQL
systemctl status postgresql
sudo -u postgres psql -c "SELECT version();"

# 4. Check if pgvecto-rs/vchord available
ls /nix/store/*postgresql*/share/postgresql/extension/ | grep -i vect

# 5. Try Immich
sudo systemctl restart podman-immich-server
journalctl -u podman-immich-server -f

# 6. Verify containers
sudo podman ps

# 7. Verify NVIDIA
nvidia-smi
```

---

## Rollback Plan

If upgrade fails:

```bash
# 1. Boot previous generation from GRUB menu
# OR

# 2. Revert flake changes
cd ~/.nixos
git checkout HEAD~1 -- flake.nix flake.lock

# 3. Rebuild with old version
sudo nixos-rebuild switch --flake .#hwc-server
```

---

## Risk Assessment

| Component | Risk | Mitigation |
|-----------|------|------------|
| PostgreSQL | Low | Version pinned to 15, explicit config |
| NVIDIA | Low | `open = false` already set |
| Containers | Low | Container images independent of host |
| Networking | Low | Tailscale handles most networking |
| Immich | Medium | May still need database cleanup |
| Home Manager | Low | Matching version update |

**Overall Risk: LOW to MEDIUM**

The upgrade is straightforward. Main uncertainty is whether 24.11 has vchord support for Immich.

---

## If Immich Still Fails After Upgrade

If vchord is still unavailable in 24.11:

```bash
# Option 1: Drop and recreate immich database
sudo -u postgres psql -c "DROP DATABASE immich;"
sudo -u postgres psql -c "CREATE DATABASE immich OWNER immich;"

# Then restart Immich - it will recreate schema with available extensions
sudo systemctl restart podman-immich-server

# Photos in /mnt/photos remain - Immich will need to re-scan/re-import
```

---

## References

- [NixOS 24.11 Release Notes](https://nixos.org/manual/nixos/stable/release-notes)
- [NixOS 24.11 Announcement](https://nixos.org/blog/announcements/2024/nixos-2411/)
- [Home Manager 24.11](https://github.com/nix-community/home-manager/tree/release-24.11)
- [pgvecto-rs GitHub](https://github.com/tensorchord/pgvecto.rs)
- [VectorChord (vchord)](https://github.com/tensorchord/VectorChord)
